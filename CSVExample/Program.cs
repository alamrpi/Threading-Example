namespace CSVExample
{
    public class Program
    {
        static void Main(string[] args)
        {
            #region DataCsv
            File.WriteAllText(Shared.FilePath, "1,Dana,Copello,dcopello0@hp.com,Male\r\n2,Gerrard,Collihole,gcollihole1@bizjournals.com,Male\r\n3,Tally,Hardbattle,thardbattle2@bbb.org,Male\r\n4,Vivia,Darinton,vdarinton3@4shared.com,Female\r\n5,Noelyn,MacAndreis,nmacandreis4@virginia.edu,Female\r\n6,Ruperto,Creasy,rcreasy5@nps.gov,Male\r\n7,Sylas,Parkhouse,sparkhouse6@drupal.org,Male\r\n8,Pearla,Stovell,pstovell7@geocities.com,Female\r\n9,Annadiana,Leglise,aleglise8@spiegel.de,Female\r\n10,Gabey,Childers,gchilders9@va.gov,Genderfluid\r\n11,Dorie,Dossit,ddossita@ftc.gov,Female\r\n12,Murdock,Carncross,mcarncrossb@statcounter.com,Male\r\n13,Clea,Gummer,cgummerc@dailymail.co.uk,Female\r\n14,Cami,Lowseley,clowseleyd@canalblog.com,Female\r\n15,Alfons,Daysh,adayshe@rambler.ru,Male\r\n16,Daile,Hazeup,dhazeupf@latimes.com,Female\r\n17,Prue,Dackombe,pdackombeg@miitbeian.gov.cn,Female\r\n18,Bondie,Gosby,bgosbyh@multiply.com,Male\r\n19,Emelen,Martini,emartinii@amazon.co.uk,Male\r\n20,Reinald,Gerrad,rgerradj@friendfeed.com,Male\r\n21,Tobiah,Dockrey,tdockreyk@de.vu,Male\r\n22,Chas,Spurritt,cspurrittl@soundcloud.com,Male\r\n23,Willyt,Bolf,wbolfm@sakura.ne.jp,Female\r\n24,Bryna,Staveley,bstaveleyn@bloglines.com,Genderfluid\r\n25,Selle,Roles,sroleso@ovh.net,Female\r\n26,Vidovik,Canet,vcanetp@craigslist.org,Male\r\n27,Lane,Brooker,lbrookerq@census.gov,Male\r\n28,Melisse,MacRannell,mmacrannellr@scribd.com,Female\r\n29,Mildred,Pischoff,mpischoffs@fema.gov,Female\r\n30,Wilburt,Iacovides,wiacovidest@va.gov,Male\r\n31,Gregoor,Klimuk,gklimuku@addtoany.com,Male\r\n32,Lanni,Skully,lskullyv@omniture.com,Female\r\n33,Tristan,Simionato,tsimionatow@aboutads.info,Male\r\n34,Costanza,Punt,cpuntx@friendfeed.com,Female\r\n35,Kalina,Ladon,kladony@usa.gov,Female\r\n36,Jarred,Liddard,jliddardz@cbsnews.com,Male\r\n37,Rolando,Anear,ranear10@aol.com,Male\r\n38,Silvana,Hatherall,shatherall11@is.gd,Agender\r\n39,Gigi,Edgerton,gedgerton12@census.gov,Female\r\n40,Bax,Roocroft,broocroft13@joomla.org,Polygender\r\n41,Bryant,Housden,bhousden14@privacy.gov.au,Male\r\n42,Amerigo,Ibotson,aibotson15@marketwatch.com,Male\r\n43,Halsey,Collinette,hcollinette16@dell.com,Male\r\n44,Robbie,Joris,rjoris17@tuttocitta.it,Genderqueer\r\n45,Vevay,McKoy,vmckoy18@xinhuanet.com,Female\r\n46,Sylas,Seedhouse,sseedhouse19@bbb.org,Male\r\n47,Claudine,Gouldbourn,cgouldbourn1a@prweb.com,Female\r\n48,Chance,Windebank,cwindebank1b@quantcast.com,Male\r\n49,Alejandrina,Tullis,atullis1c@google.ca,Female\r\n50,Glen,Raysdale,graysdale1d@last.fm,Male\r\n51,Morgun,Furber,mfurber1e@t-online.de,Male\r\n52,Elia,Chadburn,echadburn1f@home.pl,Male\r\n53,Guinna,Cakes,gcakes1g@upenn.edu,Female\r\n54,Fonsie,Follacaro,ffollacaro1h@twitter.com,Male\r\n55,Hollie,Barthorpe,hbarthorpe1i@samsung.com,Female\r\n56,Giffy,Vecard,gvecard1j@w3.org,Male\r\n57,Beverlie,Asel,basel1k@scientificamerican.com,Female\r\n58,Callida,Westerman,cwesterman1l@discuz.net,Female\r\n59,Ethel,Oaten,eoaten1m@g.co,Female\r\n60,Clemmie,Giacopini,cgiacopini1n@odnoklassniki.ru,Male\r\n61,Shermie,Brownscombe,sbrownscombe1o@tinyurl.com,Male\r\n62,Aloysia,Goldwater,agoldwater1p@archive.org,Bigender\r\n63,Shannon,Dunsmuir,sdunsmuir1q@amazon.de,Male\r\n64,Davie,McKibbin,dmckibbin1r@ehow.com,Male\r\n65,Cherin,Fipp,cfipp1s@yale.edu,Female\r\n66,Delainey,Mallia,dmallia1t@list-manage.com,Male\r\n67,Bord,Clyde,bclyde1u@hc360.com,Male\r\n68,Cloe,Bullier,cbullier1v@accuweather.com,Female\r\n69,Jeromy,Fryd,jfryd1w@ustream.tv,Male\r\n70,Matthias,Attwooll,mattwooll1x@cornell.edu,Male\r\n71,Gilbert,Basant,gbasant1y@nbcnews.com,Male\r\n72,Silvano,Robion,srobion1z@123-reg.co.uk,Male\r\n73,Yancey,Eneas,yeneas20@guardian.co.uk,Male\r\n74,Greggory,End,gend21@mozilla.com,Male\r\n75,Eldin,Tesdale,etesdale22@soup.io,Male\r\n76,Colver,Abrashkin,cabrashkin23@nature.com,Male\r\n77,Drake,Hallwood,dhallwood24@discovery.com,Male\r\n78,Ogdan,Piper,opiper25@census.gov,Bigender\r\n79,Kylie,Ruger,kruger26@businessinsider.com,Bigender\r\n80,Garik,Highman,ghighman27@scribd.com,Male\r\n81,Ailee,Millett,amillett28@cbc.ca,Female\r\n82,Ring,Hampshire,rhampshire29@cyberchimps.com,Male\r\n83,Garfield,Hannaway,ghannaway2a@dailymotion.com,Male\r\n84,Miguel,Filippov,mfilippov2b@omniture.com,Male\r\n85,Britte,Williscroft,bwilliscroft2c@ox.ac.uk,Female\r\n86,Elston,Trott,etrott2d@reddit.com,Male\r\n87,Guthrey,Van Der Walt,gvanderwalt2e@harvard.edu,Male\r\n88,Melisa,Demer,mdemer2f@dailymail.co.uk,Female\r\n89,Kendrick,Warke,kwarke2g@state.tx.us,Male\r\n90,Johannes,Mathy,jmathy2h@biglobe.ne.jp,Male\r\n91,Garwin,Leonards,gleonards2i@deviantart.com,Male\r\n92,Cristy,Dabbes,cdabbes2j@phoca.cz,Female\r\n93,Yasmin,Izhaky,yizhaky2k@xinhuanet.com,Female\r\n94,Gretta,Grinham,ggrinham2l@photobucket.com,Female\r\n95,Julianne,Crenshaw,jcrenshaw2m@t.co,Female\r\n96,Paule,Ivankin,pivankin2n@usgs.gov,Female\r\n97,Lionello,Finlan,lfinlan2o@sakura.ne.jp,Male\r\n98,Jervis,Yter,jyter2p@gnu.org,Male\r\n99,Debra,Rubinivitz,drubinivitz2q@engadget.com,Female\r\n100,Ragnar,Skene,rskene2r@exblog.jp,Male,\r\n1,Graig,Bramwell,gbramwell0@webs.com,Male\r\n2,Kara-lynn,Heal,kheal1@jiathis.com,Female\r\n3,Marni,Champ,mchamp2@tuttocitta.it,Female\r\n4,Reinald,Jinkinson,rjinkinson3@homestead.com,Male\r\n5,Ulrika,Clemetts,uclemetts4@loc.gov,Non-binary\r\n6,Tess,Alexsandrev,talexsandrev5@trellian.com,Female\r\n7,Roland,Gavriel,rgavriel6@istockphoto.com,Male\r\n8,Carolyne,Brocklehurst,cbrocklehurst7@meetup.com,Female\r\n9,Abran,Binstead,abinstead8@dot.gov,Male\r\n10,Nestor,Weedall,nweedall9@paypal.com,Male\r\n11,Indira,Nayshe,inayshea@so-net.ne.jp,Female\r\n12,Kenon,Casaletto,kcasalettob@dedecms.com,Male\r\n13,Leicester,Sponton,lspontonc@zimbio.com,Male\r\n14,Velma,Haddon,vhaddond@yahoo.com,Genderqueer\r\n15,Lorry,Adolthine,ladolthinee@disqus.com,Female\r\n16,Micah,Blackaller,mblackallerf@senate.gov,Polygender\r\n17,Trenton,Colcutt,tcolcuttg@cbsnews.com,Male\r\n18,Gusty,Swatheridge,gswatheridgeh@unblog.fr,Female\r\n19,Darrin,Majury,dmajuryi@merriam-webster.com,Male\r\n20,Livvie,Hartup,lhartupj@kickstarter.com,Female\r\n21,Lauren,Terzi,lterzik@usa.gov,Male\r\n22,Thekla,Tooher,ttooherl@stanford.edu,Agender\r\n23,Melodee,MacGahey,mmacgaheym@irs.gov,Female\r\n24,Uriah,Gogay,ugogayn@nydailynews.com,Male\r\n25,Alena,Jikylls,ajikyllso@netscape.com,Female\r\n26,Quinta,Tupp,qtuppp@google.com.br,Female\r\n27,Breena,Scrowby,bscrowbyq@wunderground.com,Female\r\n28,Eberhard,Thulborn,ethulbornr@princeton.edu,Male\r\n29,Herve,McLese,hmcleses@mail.ru,Male\r\n30,Derk,Bengtsen,dbengtsent@marriott.com,Male\r\n31,Magda,Baines,mbainesu@whitehouse.gov,Female\r\n32,Beth,Pourveer,bpourveerv@people.com.cn,Female\r\n33,Antonia,Corse,acorsew@parallels.com,Female\r\n34,Mandy,Croker,mcrokerx@furl.net,Female\r\n35,Edsel,Kleinholz,ekleinholzy@home.pl,Male\r\n36,Dani,Bisseker,dbissekerz@wikipedia.org,Female\r\n37,Meryl,Crewe,mcrewe10@discovery.com,Polygender\r\n38,Jay,Cordon,jcordon11@addthis.com,Male\r\n39,Dean,Barde,dbarde12@webmd.com,Male\r\n40,Svend,Germain,sgermain13@google.ca,Male\r\n41,Celestyn,Cavanaugh,ccavanaugh14@livejournal.com,Female\r\n42,Aeriela,Augustin,aaugustin15@storify.com,Female\r\n43,Brockie,Guillain,bguillain16@cnn.com,Male\r\n44,Donovan,Hackwell,dhackwell17@issuu.com,Male\r\n45,Burg,Bowser,bbowser18@amazon.de,Male\r\n46,Ivy,Kulvear,ikulvear19@digg.com,Female\r\n47,Bev,Stenton,bstenton1a@google.ca,Female\r\n48,Silvio,Mattaus,smattaus1b@jiathis.com,Male\r\n49,Dimitry,Jacobovitch,djacobovitch1c@instagram.com,Bigender\r\n50,Anson,Gronowe,agronowe1d@nyu.edu,Male\r\n51,Wendye,Boc,wboc1e@ca.gov,Female\r\n52,Austine,McCunn,amccunn1f@mapy.cz,Female\r\n53,Marris,Sholem,msholem1g@google.cn,Female\r\n54,Sheena,Downton,sdownton1h@sun.com,Female\r\n55,Ayn,Gildersleaves,agildersleaves1i@ihg.com,Female\r\n56,Leonerd,Giurio,lgiurio1j@google.nl,Male\r\n57,Joby,Densey,jdensey1k@stumbleupon.com,Female\r\n58,Rog,Cluely,rcluely1l@msn.com,Male\r\n59,Arlan,Beament,abeament1m@parallels.com,Male\r\n60,Tannie,Verey,tverey1n@lulu.com,Male\r\n61,Rozella,Normington,rnormington1o@bizjournals.com,Female\r\n62,Kacy,Balcock,kbalcock1p@sina.com.cn,Female\r\n63,Shermy,Lago,slago1q@canalblog.com,Male\r\n64,Lorena,Anear,lanear1r@prnewswire.com,Female\r\n65,Trudi,Bywater,tbywater1s@cam.ac.uk,Female\r\n66,Carly,Heinke,cheinke1t@sogou.com,Female\r\n67,Dalenna,Elloy,delloy1u@altervista.org,Female\r\n68,Vinny,Shutler,vshutler1v@chron.com,Female\r\n69,Patience,Christoforou,pchristoforou1w@soup.io,Female\r\n70,Randall,Tolussi,rtolussi1x@flickr.com,Male\r\n71,Granny,Northgraves,gnorthgraves1y@wsj.com,Male\r\n72,Denny,Brockman,dbrockman1z@walmart.com,Female\r\n73,Derward,O'Cannavan,docannavan20@nba.com,Male\r\n74,Missy,Egerton,megerton21@scribd.com,Female\r\n75,Sigmund,Jirieck,sjirieck22@acquirethisname.com,Male\r\n76,Lorenzo,Morlon,lmorlon23@1688.com,Male\r\n77,Isa,Waliszewski,iwaliszewski24@nih.gov,Genderqueer\r\n78,Rafferty,Mayoral,rmayoral25@e-recht24.de,Male\r\n79,Gerry,Anchor,ganchor26@accuweather.com,Male\r\n80,Boigie,Kevlin,bkevlin27@skype.com,Male\r\n81,Nicolis,Deare,ndeare28@springer.com,Male\r\n82,Sunny,Celloni,scelloni29@paypal.com,Male\r\n83,Haslett,Richmont,hrichmont2a@walmart.com,Male\r\n84,Meade,Kench,mkench2b@cocolog-nifty.com,Male\r\n85,Caria,Jewster,cjewster2c@dailymotion.com,Female\r\n86,Ingeberg,Greystoke,igreystoke2d@furl.net,Female\r\n87,Silva,Domenge,sdomenge2e@ask.com,Female\r\n88,Gae,Yakubowicz,gyakubowicz2f@51.la,Female\r\n89,Petra,Scamwell,pscamwell2g@earthlink.net,Female\r\n90,Florrie,McCooke,fmccooke2h@phpbb.com,Female\r\n91,Baily,Deem,bdeem2i@live.com,Male\r\n92,Ellette,McLaverty,emclaverty2j@dedecms.com,Female\r\n93,Derrik,Bilovus,dbilovus2k@about.me,Male\r\n94,Alica,Venour,avenour2l@twitpic.com,Female\r\n95,Ann,Lillgard,alillgard2m@amazon.de,Female\r\n96,Maudie,Carde,mcarde2n@cdc.gov,Non-binary\r\n97,Kesley,Penning,kpenning2o@ftc.gov,Female\r\n98,Osbert,Zumbusch,ozumbusch2p@unc.edu,Male\r\n99,Vic,Christophersen,vchristophersen2q@newsvine.com,Male\r\n100,Aldo,Clacson,aclacson2r@nasa.gov,Male");
            #endregion

            //Read data from the file
            using (StreamReader sr = new(Shared.FilePath))
            {
                string? line;
                int lineNumber = 0;

                //Create a chunk (an empty list of string)
                List<string> chunk = new List<string>();
                
                //Create a collection of threads
                List<Thread> threads = new List<Thread>();
                int threadCount = 0;

                //Create a semaphore to limit the number of concurrent threads
                Semaphore semaphore = new(Shared.MaxConcurrent, Shared.MaxConcurrent);

                //Read each line from the file
                while ((line = sr.ReadLine()) != null)
                {
                    //Skip the iteration if the line is null
                    if(string.IsNullOrEmpty(line)) continue;
                    lineNumber++;
                    chunk.Add(line);
                    if(lineNumber % Shared.ChunkSize == 0)
                    {
                        //Create a duplicate of chunk
                        List<string> chunkCopy = chunk.Select(temp => temp).ToList();

                        //Create chunk name
                        string chunkName = $"Chunk {threadCount}";

                        Thread thread = new Thread(() =>
                        {
                            //Wait for the semaphore to be available
                            semaphore.WaitOne();

                            try
                            {
                                InvokeDataProcessor(chunkName, chunkCopy);
                            }
                            catch (Exception ex) 
                            {

                                Console.WriteLine(ex.Message);
                            }
                            finally
                            {
                                semaphore.Release();
                            }
                        });
                        threadCount++;
                        threads.Add(thread);
                        thread.Start();
                        chunk.Clear();

                    }
                }

                if(chunk.Count > 0)
                {
                    //Create chunk name
                    string chunkName = $"Chunk {threadCount}";

                    Thread thread = new Thread(() =>
                    {
                        InvokeDataProcessor(chunkName, chunk);
                    });
                    threadCount++;
                    threads.Add(thread);
                    thread.Start();
                }

                foreach (var thread in threads)
                {
                    thread.Join();
                }
            }
        }

        static void InvokeDataProcessor(string chunkName, List<string> chunk)
        {
            //create a object of data processor
            var dataProcessor = new DataProcessor()
            {
                Chunk = chunk,
                ChunkName = chunkName
            };

            Console.WriteLine($"Processing {chunkName} of size {chunk.Count}");

            //Invoke ProcessChunk method to perform actual process of data
            dataProcessor.ProcessChunk();

            //lock (Shared.LockObject)
            //{
            //    Console.WriteLine($"Processed {chunkName} of size {chunk.Count}");
            //    Console.WriteLine(dataProcessor.ChunkName);
            //    foreach (var gender in dataProcessor.GenderCounts)
            //    {
            //        Console.WriteLine($"{gender.Key}: {gender.Value}");
            //    }
            //}

            try
            {
                Shared.Mutex.WaitOne();
                Console.WriteLine($"Processed {chunkName} of size {chunk.Count}");
                Console.WriteLine(dataProcessor.ChunkName);
                foreach (var gender in dataProcessor.GenderCounts)
                {
                    Console.WriteLine($"{gender.Key}: {gender.Value}");
                }
            }
            catch (Exception ex)
            {

                Console.WriteLine(ex.Message);
            }
            finally
            {
                Shared.Mutex.ReleaseMutex();
            }
        }
    }
}
